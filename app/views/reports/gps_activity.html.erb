<% content_for :head do %>
  <script type="text/javascript" src="<%= APP_CONFIG[:google_maps_url] %>"></script>

  <%= stylesheet_link_tag "bootstrap-datepicker" %>
  <%= javascript_include_tag "bootstrap-datetimepicker" %>
  <%= javascript_include_tag "location_history_map" %>
<% end %>

<div id="mapdiv"></div>

<div class="container-fluid" id="main">
  <div class="row">
  	<div class="col-xs-4 col-md-4" id="left">

      <%= form_tag location_history_path, :method => 'get', :class => 'form-horizontal' do %>

        <%= hidden_field_tag :date_from %>
        <%= hidden_field_tag :date_to %>

        <div class="form-group">
          <label for="devices" class="col-sm-2 control-label">Devices</label>
          <div class="col-sm-10">
            <%= select_tag "Devices",
                           options_from_collection_for_select(@devices, "id", "uuid"),
                           {:include_blank => false, :multiple => false, :class => 'form-control' } %>
          </div>
        </div>

        <div class="form-group">
          <label for="devices" class="col-sm-2 control-label">From</label>
          <div class="col-sm-10">

            <div class='input-group date' id='datetimepickerFrom'>
              <input type='text' class="form-control" />
              <span class="input-group-addon">
                <span class="glyphicon glyphicon-calendar"></span>
              </span>
            </div>

          </div>
        </div>

        <div class="form-group">
          <label for="devices" class="col-sm-2 control-label">To</label>
          <div class="col-sm-10">

            <div class='input-group date' id='datetimepickerTo'>
              <input type='text' class="form-control" />
              <span class="input-group-addon">
                <span class="glyphicon glyphicon-calendar"></span>
              </span>
            </div>

          </div>
        </div>

        <div class="form-group">
          <div class="col-sm-offset-2 col-sm-10">
            <button type="submit" class="btn btn-default">Submit</button>
          </div>
        </div>
      <% end %>

    </div>

    <div class="col-xs-8 col-md-8"><!--map-canvas will be postioned here--></div>

  </div>
</div>

<script language="JavaScript">
  $(document).ready(function(){
    var date_format = "YYYY-MM-DD HH:mm:00";
    var date_begin = moment().format('<%= params[:date_from].blank? ? "YYYY-MM-DD 08:00:00" : params[:date_from] %>');
    var date_end = moment().format('<%= params[:date_to].blank? ? "YYYY-MM-DD 18:00:00" : params[:date_to] %>');

    $("#datetimepickerFrom").datetimepicker({
      format: date_format,
      language: 'en',
      defaultDate: date_begin

    });
    $("#datetimepickerTo").datetimepicker({
      format: date_format,
      language: 'en',
      defaultDate: date_end
    });

    $("#datetimepickerFrom").on("dp.change",function (e) {
      $('#date_from').val(e.date.format(date_format));
    });

    $("#datetimepickerTo").on("dp.change",function (e) {
       $('#date_to').val(e.date.format(date_format));
    });

    initMap();
    createMarkers(<%= @locations.to_json.html_safe %>);
  });
</script>